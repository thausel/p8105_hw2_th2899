---
title: "Quant Lab 1"
author: "Tim Hauser"
date: "due 10/XX/2022"
output: 
  html_document: 
    toc: true
    toc_float: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(tidyverse)
library(knitr)
knitr::opts_chunk$set(echo = TRUE)
```

### Objectives of Quant Lab 1
* Understand random sampling from a population and the importance of setting a seed.

* Compare stratified random sampling strategies.

* Conduct sample size calculations. 

***

### Background for Quant Lab 1

You hypothesize that exposure to perfluorinated compounds (PFC)--perfluorooctane sulfonate (PFOS) and perfluorooctanoic acid (PFOA) are associated with obesity. You plan to use the NHANES dataset to test this association and want to conduct a pilot analysis to figure out: 

1) how big of a difference in PFOS and PFOA you can expect to see between obese and non-obese individuals

2) how many samples you need to analyze for PFOS and PFOA to detect a statistically significant (at alpha = 0.05) between PFOS and obesity and PFOA and obesity.

Assume that you only have funds for 30 pilot samples. 

***

### Data for Quant Lab 1
For this lab, we will use the adults in NHANES cycle 2015-2016 with both BMI and PFC data.  
https://wwwn.cdc.gov/nchs/nhanes/continuousnhanes/default.aspx?BeginYear=2015
https://wwwn.cdc.gov/Nchs/Nhanes/2015-2016/PFAS_I.htm

* For Part 1 of the lab, use "nh1516_pt1.rds".

* For Part 2 of this lab, you will need to merge in "nh1516_pt2.rds".

For this lab, we will *ignore* survey weighting. 

***

### Set-up

Load tidyvery and Hmisc libraries and data sets:

```{r set_up, include = T, echo = T}
# load tidyverse library
library(tidyverse)

# load Hmisc library (for describe function)
library(Hmisc)

# load data
nh1516_pt1 = readRDS("nh1516_pt1.rds")
nh1516_pt2 = readRDS("nh1516_pt2.rds")
```

***

### Part 1: Picking your samples

* Use the standard CDC categories for obesity to create 4 categories: underweight, healthy, overweight, obesity
https://www.cdc.gov/obesity/adult/defining.html
* Categories include:  underweight, healthy, overweight, obese

The following code creates BMI categories & changes the new variable into a factor variable:

```{r cdc_cats, echo = T, eval = F}
nh1516_pt1 = nh1516_pt1 %>% 
  mutate(cdc_cats = 
           if_else(bmi < 18.5, "underweight",
                   if_else(bmi >= 18.5 & bmi < 25, "healthy", 
                           if_else(bmi >= 25 & bmi < 30, "overweight", 
                                   if_else(bmi >= 30, "obesity", NA_character_, missing = NULL))))) %>% 
  mutate(cdc_cats = as.factor(cdc_cats))
```

While at it, we also create a new variable obese vs. non-obese (to be used in strategy B):

```{r}
nh1516_pt1 = nh1516_pt1 %>% 
  mutate(cdc_cats_2 = if_else(bmi < 30, "non-obese", "obese")) %>% 
  mutate(cdc_cats_2 = as.factor(cdc_cats_2))
```


#### Strategy A: Random Sample

* Pick a random sample of 30 participants and save as "strat_a1" using seed(10032)

```{r}
set.seed(10032)
strat_a1 = sample_n(nh1516_pt1, 30)
```

* Pick a random sample of 30 participants and save as "strat_a2" using seed(10027)

```{r}
set.seed(10027)
strat_a2 <- sample_n(nh1516_pt1, 30)
```


#### Strategy B: Stratified Random Sample of Obese and Non-Obese 

* Pick a random sample of 15 obese participants and 15 non-obese participants using seed 1 and save as "strat_b1"
* Use the standard CDC categories for obese and non-obese

We take a random sample of 15 obese and non-obese participants each:

```{r}
set.seed(10032)
strat_b1 = nh1516_pt1 %>% group_by(cdc_cats_2) %>% sample_n(15)
```

* Pick a random sample of 15 obese participants and 15 non-obese participants using seed 2 and save as "strat_b2"

```{r}
set.seed(10027)
strat_b2 = nh1516_pt1 %>% group_by(cdc_cats_2) %>% sample_n(15)
```


#### Strategy C: Stratified Random Sample of Obese vs Healthy 
* Pick a random sample of 15 obese participants and 15 healthy weight participants using seed #1 and save as "strat_c1"
* Use the standard CDC categories for obese vs. healthy

I am using the bind rows command to combine two samples of randomly selected healthy and obese participants (15 each):

```{r}
set.seed(10032)
strat_c1 = bind_rows(
  nh1516_pt1 %>% group_by(cdc_cats = "healthy") %>% sample_n(15),
  nh1516_pt1 %>% group_by(cdc_cats = "obesity") %>% sample_n(15)
  )
```


* Pick a random sample of 15 obese participants and 15 healthy weight participants using seed #2 and save as "strat_c2"

```{r}
set.seed(10027)
strat_c2 = bind_rows(
  nh1516_pt1 %>% group_by(cdc_cats = "healthy") %>% sample_n(15),
  nh1516_pt1 %>% group_by(cdc_cats = "obesity") %>% sample_n(15)
  )
```


### Explore pilot selection by obesity status

**Question 1A:** What is the distribution of CDC BMI categories when using strategy A. (Stated differently:  How many and what proportion of your N=30 are obese, overweight, healthy, and underweight?). Do this separately by seed.

For seed 1, we have 7 healthy (23.3%), 15 obese (50%), 7 overweight (23.3%), and 1 underweight (3.3%) participants:

```{r, echo = T, eval = F}
table(strat_a1$cdc_cats)
prop.table(table(strat_a1$cdc_cats))
```

For seed 1, we have 10 healthy (33.3%), 12 obese (40%), 6 overweight (20%), and 2 underweight (6.7%) participants:

```{r, echo = T, eval = F}
table(strat_a2$cdc_cats)
prop.table(table(strat_a2$cdc_cats))
```


**Question 1B:** What is the distribution of CDC BMI categories when using strategy B. (Stated differently:  How many and what proportion of your N=30 are obese, overweight, healthy, and underweight?). Do this separately by seed.

For seed 1, we have 5 healthy (16.7%), 15 obese (50%), 10 overweight (33.3%), and 0 underweight (0%) participants:

```{r, echo = T, eval = F}
table(strat_b1$cdc_cats)
prop.table(table(strat_b1$cdc_cats))
```

For seed 2, we have 7 healthy (23.3%), 15 obese (50%), 8 overweight (26.7%), and 0 underweight (0%) participants:

```{r, echo = T, eval = F}
table(strat_b2$cdc_cats)
prop.table(table(strat_b2$cdc_cats))
```


**Question 1C:** What is the distribution of CDC BMI categories when using strategy C. (Stated differently:  How many and what proportion of your N=30 are obese, overweight, healthy, and underweight?). Do this separately by seed.

For seed 1, we have 15 healthy (50%), 15 obese (50%), 0 overweight (0%), and 0 underweight (0%) participants:

```{r, echo = T, eval = F}
table(strat_c1$cdc_cats)
prop.table(table(strat_c1$cdc_cats))
```

For seed 2, we have 12 healthy (50%), 15 obese (50%), 0 overweight (0%), and 0 underweight (0%) participants:

```{r, echo = T, eval = F}
table(strat_c2$cdc_cats)
prop.table(table(strat_c2$cdc_cats))
```


**Question 2A:** Which of these strategies will give you the best contrast between outcome groups (and why)?

Strategy C, since this sample contains only member from the two population groups that are likely to have a contrast in exposure (i.e., in PFC levels) since we know already that have a high contrast in outcome (i.e., obese vs. healthy patients) - the assumption going in here is that difference in outcomes are indeed linked to differences in exposure. The contrast between obese vs. healthy patients is this likely to be more stark than the contrast between obese vs. non-obese participants (which also includes overweight patients that potentially display more similarities to obese participants than health participants would).

**Question 2B:** Which of these strategies will give you the best estimate of the PFC distribution in the population (and why)?

Strategy A, since this sample comes mimics most closely what is found in the real population, hence we can make the best estimates about PFC distribution.


### Part 2: Lab data

* Note how many of your lab values are < limit of detection.
* Look at the distribution of PFOS and PFOA.  Log-adjust if the distribution is not log-normal. 

0.6% of all PFOS values cannot be detected (10 in total), while 0.9% (15 in total) of all PFOA values cannot be detected.

```{r}
describe(nh1516_pt2$pfos_dl)
describe(nh1516_pt2$pfoa_dl)
```

Before log-adjustment, histograms are difficult to read:

```{r}
hist(nh1516_pt2$pfos)
hist(nh1516_pt2$pfoa)
```

Log transforming the PFOS and PFOA values:

```{r}
nh1516_pt2 <- nh1516_pt2 %>% mutate(pfos_log = log(pfos), pfoa_log = log(pfoa))
```

The histograms of the log-adjusted values are now readable:

```{r}
hist(nh1516_pt2$pfos_log)
hist(nh1516_pt2$pfoa_log)
```

Most log-adjusted PFOS values are around 0.5 to 2 an most log-adjusted PFOA values are around -0.5 to 1.

* Merge in PFC data for the pilot samples under each of the 3 strategies (do this separately for each seed).

The commands below adds the PFC info from the nh1516_pt2 dataset to each sample:

```{r}
strat_a1_new = merge(strat_a1 , nh1516_pt2 , by="SEQN", all=F)
strat_a2_new = merge(strat_a2 , nh1516_pt2 , by="SEQN", all=F)
strat_b1_new = merge(strat_b1 , nh1516_pt2 , by="SEQN", all=F)
strat_b2_new = merge(strat_b1 , nh1516_pt2 , by="SEQN", all=F)
strat_c1_new = merge(strat_c1 , nh1516_pt2 , by="SEQN", all=F)
strat_c2_new = merge(strat_c2 , nh1516_pt2 , by="SEQN", all=F)

```

### Explore the data by strategy

Complete the tables in the assignment doct all 3 strategies:

**Question 3A:** Using Strategy A, compare the mean and sd of obese vs. non-obese (all other CDC categories combined).  Show the N for each group. Do this separately by seed. Complete and include the table above. 

```{r}
strat_a1_new %>% group_by(pfos) %>% summarise(mean(pfos), sd(pfos))
```



```{r}
table(strat_a1_new$pfos)
```


```{r Q3, echo = T, eval = F}
table(df$var)

df %>% groupby(var) %>% summarise(mean(var), 
                                  sd(var))
```


**Question 4A:** Using Strategy B, compare the mean and sd of obese vs. non-obese (all other CDC categories combined).  Show the N for each group. Do this separately by seed. Complete and include the table above. 


**Question 4B:** Run a t-test comparing the means of ln_pfos and ln_pfoa by obese vs. non-obese.  Do this separately by seed.  Are the relationships significant?  Is the direction the same (e.g., are obese > non-obese using both seeds)? 


**Question 5A:** Using Strategy C, compare the mean and sd of obese vs. non-obese.  Show the N for each group. Do this separately by seed. Complete and include the table above. 


**Question 5B:** Run a t-test comparing the means of ln_pfos and ln_pfoa by obese vs. non-obese.  Do this separately by seed.  Are the relationships significant?  Is the direction the same (e.g., are obese > non-obese using both seeds)? 


**Question 6A:** Under Strategy A, calculate how many samples you would need to detect a significant association the PFOS and PFOA levels among obese vs. non-obese participants.  Do this separately by seed. Note: always round sample size estimates up (e.g., if n=100.3, you need 101 people per group).

```{r Q6A, eval = F}
# load the library pwr
library(pwr) 
	
# inputs for power calculation:

# the two means: the mean for Group 1 (obese) and the mean for Group 2 (non-obese):
# mean1
# mean2

# pooled standard deviation: which is the square root of the average of the two standard deviations squared:
sd_pool = sqrt((sd1^2 + sd2^2)/2) 

# The default significance level (alpha level) is .05 

# We will set the power to be at .8

pwr.t.test(d=(mean1-mean2)/sd_pool,power=.8,sig.level=.05,type="two.sample",alternative="two.sided")
```


**Question 6B:** Under Strategy B, calculate how many samples you would need to detect a significant association the PFOS and PFOA levels among obese vs. non-obese participants.  Do this separately by seed. 


**Question 6C:** Under Strategy C, calculate how many samples you would need to detect a significant association the PFOS and PFOA levels among obese vs. non-obese participants.  Do this separately by seed. 


**Question 7**:  Under what circumstances were the sample size estimates the largest (e.g., comment on the difference you are looking to the detect and the standard deviation).


**Question 8**:  Are you surprised that the p-values from the t-tests were largely not significant?


**Question 9**: Why does the same comparison sometime vary so much by seed? 


**Question 10**: Which strategy for picking pilot samples in this case is preferable?  Justify your answer. 

